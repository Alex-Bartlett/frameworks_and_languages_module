<html>
	<head>
		<meta charset="utf-8" />
		<link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,....==" />
		<title>FreeCycle Example Client</title>
<style>

html, body {
	font-family: Arial, Helvetica, sans-serif;
	margin: 0;
	padding: 0;
}
a {
	color: inherit;
	text-decoration: inherit;
}

#nav div {
	display: inline-block;
}

#nav h1 {
	margin: 0;
	padding: 0;
	display: inline-block;
}

#menu li {
	display: inline-block;
}

#user {
	float: right;
}

#main {

}

#templates {
	display: none;
}

</style>
	</head>
	<body>
		<div id="nav">
			<div id="logo">
				<a href="#">
					&#128205; <!-- Unicode for Map Pin - https://unicode-table.com/en/1F4CD/ -->
					<h1>FreeCycle</h1>
				</a>
			</div>
			<div id="menu">
				<ul>
					<li>
						<a href="#items">Items</a>
					</li>
					<li>
						<a href="#create">Create</a>
					</li>
				</ul>
			</div>
			<div id="user">
			</div>
		</div>

		<div id="main">

		</div>

		<div id="templates">

			<div class="unknown">
				Unknown page
			</div>

			<div class="about">
				Welcome
			</div>

			<div class="items">
				List items
			</div>



			<div class="create">
				Create item
				<button data-action="test">Test</button>
			</div>

			<div class="signin">
				<form>
					<input type="text" name="username" placeholder="username">
					<input type="password" name="password">
					<input type="submit" id="action_signin" data-action="signin">
				</form>
			</div>

		</div>
<script type="module">


	// Utils -------------------------------------------------------------------

	function clear_node(node) {
		let child;
		while (child = node.lastElementChild) {
			node.removeChild(child);
		}
	}


	// Startup -----------------------------------------------------------------

	const urlParams = new URLSearchParams(window.location.search);
	const urlAPI = urlParams.get('api') || '/api/v1';

	function redirect_to_hash({hash='#'}={}) {
		render_username_nav();
		window.location.hash = hash;
		hashchange();
	}

	// Signin/Username ---------------------------------------------------------
	let username = window.localStorage.getItem("username");
	const $user = document.getElementById('user');
	function signin(event) {
		event.preventDefault();
		username = event.target.parentElement.querySelector('input[name="username"]').value;
		window.localStorage.setItem("username", username);
		redirect_to_hash();
	}
	function signout(event) {
		username = undefined;
		window.localStorage.setItem("username", '');
		redirect_to_hash();
	}
	function render_username_nav() {
		clear_node($user);
		if (username) {
			const $username = document.createElement('span');
			$username.textContent = username;
			
			const $signout = document.createElement('a');
			$signout.id = 'signout';
			$signout.href = `#signout`;
			$signout.textContent = 'signout';

			$user.appendChild($username);
			$user.appendChild($signout);
		} else {
			const $signin = document.createElement('a');
			$signin.id = 'signin';
			$signin.href = `#signin`;
			$signin.textContent = 'signin';

			$user.appendChild($signin);
		}
	}
	render_username_nav();



	function bind_functions_to_onclick() {
		for (let $el of document.querySelectorAll("[data-action]")){
			const action = $el.dataset.action;
			if (action=='signin') {
				$el.addEventListener('click', signin);
			}
		}
	}




	function render_items() {
		function renderItems(data) {
			console.log('yeee haw', data);
		}
		fetch(`${urlAPI}/items`)
			.then(response => response.json())
			.then(renderItems)
		.catch(err => console.error(err));
	}

	function render_template({name="#unknown", requires_login=false}={}) {
		console.log('render_template', name);
		if (requires_login && !window.localStorage.getItem("username")) {
			name = '#signin';
		}
		name = name.replace('#','');
		const newClone = document.getElementById('templates').getElementsByClassName(name)[0].cloneNode(true);  // https://developer.mozilla.org/en-US/docs/Web/API/Node/cloneNode
		const main = document.getElementById('main');
		clear_node(main);
		main.appendChild(newClone);
		bind_functions_to_onclick();
	}
	const RENDERERS = {
		"":()=>render_template({name: '#about'}),
		"#signout": signout,
		"#signin"  : ()=>render_template({name: '#signin'}),
		"#items": ()=>{render_template({name: '#items'}); render_items();},
		"#create": ()=>render_template({name: '#create', requires_login: true}),
	};

	// Hash router
	function hashchange() {
		console.log('hashchange', window.location.hash);
		(RENDERERS[window.location.hash] || render_template)();
	}
	window.addEventListener('hashchange', hashchange);
	

	// First load
	hashchange();

</script>
	</body>
</html>