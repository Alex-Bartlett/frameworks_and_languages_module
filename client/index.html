<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
		crossorigin="anonymous"></script>
	<style>
		[v-cloak] {
			display: none
		}
	</style>
	<title>Free-cycle</title>
</head>

<body>
	<script type="importmap">
			{
				"imports": {
					"vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
				}
			}
		</script>

	<div id="app" v-cloak>
		<h1>Free-cycle</h1>
		<h2>Create new listing</h2>
		<form action="submit" @submit.prevent="postItem">
			<input v-model="form.user_id" type="text" name="user-id" placeholder="User ID" />
			<input v-model="form.keywords" type="text" name="keywords" placeholder="Keyword1, Keyword2, etc" />
			<input v-model="form.description" type="text" name="description" placeholder="Description" />
			<input v-model="form.image" type="text" name="image" placeholder="Image URL" />
			<input v-model="form.lat" type="text" name="latitude" placeholder="Latitude" />
			<input v-model="form.lon" type="text" name="longitude" placeholder="Longitude" />
			<input v-model="form.date_from" type="text" name="date-from" placeholder="Date from" />
			<input v-model="form.date_to" type="text" name="date-to" placeholder="Date to" />
			<input type="submit" value="Add" />
		</form>
		<div class="container">
			<div class="row">
				<div v-for="item in items" class="col-12 col-sm-6 col-md-4">
					<h2>{{item.user_id}}</h2>
					<img v-bind:src="item.image" />
					<p>{{item.description}}</p>
					<ul>
						<li v-for="kw in item.keywords">{{kw}}</li>
					</ul>
					<div>
						<div>Lat: {{lat}}</div>
						<div>Lon: {{lon}}</div>
					</div>
					<div>
						<div>From: {{date_from}}</div>
						<div>Until: {{date_to}}</div>
					</div>
					<button @click="deleteItem(item.id)">Delete</button>
				</div>
			</div>
		</div>
		<div>
			<b>API Connection Status: </b>
			<span v-if="urlAPI" style="color: green;">
				{{'Connected to '+urlAPI}}
			</span>
			<span v-else style="color: red;">
				Unconnected
			</span>
		</div>
	</div>

	<script type="module">
		import { createApp, ref, reactive } from "vue";

		const urlParams = new URLSearchParams(window.location.search);
		const urlAPI = urlParams.get("api");

		// Verify urlAPI has value before attempting to call methods upon it
		if (urlAPI) {
			urlAPI.replace(/\/$/, "");
			// if (urlAPI.endsWith("/")) {
			// 	urlAPI = urlAPI.substring(0, urlAPI.length - 1)
			// }
		}

		createApp({
			data() {
				const form = reactive({
					user_id: "",
					keywords: "",
					description: "",
					image: "",
					lat: "",
					lon: "",
					date_from: "",
					date_to: "",
				});
				let items = {};
				return {
					form,
					items,
					urlAPI
				};
			},
			methods: {
				postItem() {
					fetch(urlAPI + "/item", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(this.form),
					})
						.then((response) => response.json())
						.then((json) => {
							console.log("Post sent the following: ", JSON.stringify(json));
							this.getItems();
						})
						.catch((err) => console.log("Error:", err));
				},
				getItems() {
					fetch(urlAPI + "/items", {
						method: "GET",
						headers: { "Content-Type": "application/json" },
					})
						.then((response) => response.json())
						.then((json) => { this.items = json })
						.catch((err) => console.log("Error:", err));
				},
				deleteItem(id) {
					fetch(`${urlAPI}/item/${id}`, {
						method: "DELETE",
					})
						.then(response => {
							console.log(response);
							this.getItems()
						})
						.catch(err => console.log("Error:", err))
				},
			},
			created() {
				this.getItems()
			},
		}).mount("#app");
	</script>
</body>

</html>